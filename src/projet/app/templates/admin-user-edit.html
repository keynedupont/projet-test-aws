{% extends "base.html" %}

{% block title %}Modifier l'utilisateur - Administration{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-bg flex lg:gap-6">
    <!-- Sidebar Admin -->
    {% include "components/admin-sidebar.html" %}
    
    <!-- Contenu principal -->
    <div class="flex-1" x-data="{ sidebarCollapsed: localStorage.getItem('adminSidebarCollapsed') === 'true' }">
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- En-tête -->
            <div class="mb-8">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-3xl font-bold text-text-primary mb-2">
                            Modifier l'utilisateur
                        </h1>
                        <p class="text-text-secondary">
                            {{ user_to_edit.email }}
                        </p>
                    </div>
                    <a href="/admin/users" class="btn-secondary">
                        <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                        </svg>
                        Retour à la liste
                    </a>
                </div>
            </div>
            
            {% if request.query_params.get('success') %}
            <div class="mb-6 p-4 bg-green-50 border border-green-200 rounded-lg success-message">
                <div class="flex items-center">
                    <svg class="w-5 h-5 text-green-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <p class="text-sm text-green-600">
                        {% if request.query_params.get('success') == 'toggle' %}
                            Statut utilisateur mis à jour avec succès
                        {% elif request.query_params.get('success') == 'roles' %}
                            Rôles mis à jour avec succès
                        {% elif request.query_params.get('success') == 'update' %}
                            Informations utilisateur mises à jour avec succès
                        {% elif request.query_params.get('success') == 'verify' %}
                            Statut de vérification email mis à jour avec succès
                        {% elif request.query_params.get('success') == 'reset' %}
                            Mot de passe réinitialisé avec succès
                        {% else %}
                            Modification réussie
                        {% endif %}
                    </p>
                </div>
            </div>
            {% endif %}
            
            {% if request.query_params.get('error') %}
            <div class="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg error-message">
                <div class="flex items-center">
                    <svg class="w-5 h-5 text-red-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <p class="text-sm text-red-600">{{ request.query_params.get('error') }}</p>
                </div>
            </div>
            {% endif %}
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Informations utilisateur -->
                <div class="space-y-6">
                    <!-- Informations en lecture seule -->
                    <div class="bg-white rounded-xl shadow-card p-6 border border-gray-border">
                        <h2 class="text-xl font-semibold text-text-primary mb-6">Informations</h2>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-text-secondary mb-1">Date de création</label>
                                <p class="text-sm text-text-primary">
                                    {% if user_to_edit.created_at %}
                                        {{ user_to_edit.created_at[:10] if user_to_edit.created_at else '-' }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-text-secondary mb-1">Dernière connexion</label>
                                <p class="text-sm text-text-primary">
                                    {% if user_to_edit.last_login %}
                                        {{ user_to_edit.last_login[:10] if user_to_edit.last_login else '-' }}
                                    {% else %}
                                        <span class="text-text-muted">Jamais connecté</span>
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Modifier email/nom -->
                    <div class="bg-white rounded-xl shadow-card p-6 border border-gray-border">
                        <h2 class="text-xl font-semibold text-text-primary mb-4">Modifier les informations</h2>
                        
                        <form method="post" action="/admin/users/{{ user_to_edit.id }}/update">
                            <div class="space-y-4 mb-6">
                                <div>
                                    <label for="email" class="block text-sm font-medium text-text-secondary mb-1">Email</label>
                                    <input type="email" 
                                           id="email" 
                                           name="email" 
                                           value="{{ user_to_edit.email }}"
                                           class="w-full px-4 py-2 border border-gray-border rounded-lg focus:ring-2 focus:ring-accent focus:border-transparent">
                                </div>
                                
                                <div>
                                    <label for="first_name" class="block text-sm font-medium text-text-secondary mb-1">Prénom</label>
                                    <input type="text" 
                                           id="first_name" 
                                           name="first_name" 
                                           value="{{ user_to_edit.first_name or '' }}"
                                           class="w-full px-4 py-2 border border-gray-border rounded-lg focus:ring-2 focus:ring-accent focus:border-transparent">
                                </div>
                                
                                <div>
                                    <label for="last_name" class="block text-sm font-medium text-text-secondary mb-1">Nom</label>
                                    <input type="text" 
                                           id="last_name" 
                                           name="last_name" 
                                           value="{{ user_to_edit.last_name or '' }}"
                                           class="w-full px-4 py-2 border border-gray-border rounded-lg focus:ring-2 focus:ring-accent focus:border-transparent">
                                </div>
                            </div>
                            
                            <button type="submit" class="btn-primary w-full">
                                <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                                Enregistrer les modifications
                            </button>
                        </form>
                    </div>
                    
                    <!-- Forcer vérification email -->
                    <div class="bg-white rounded-xl shadow-card p-6 border border-gray-border">
                        <h2 class="text-xl font-semibold text-text-primary mb-4">Vérification email</h2>
                        
                        <form method="post" action="/admin/users/{{ user_to_edit.id }}/verify">
                            <div class="flex items-center justify-between mb-4">
                                <div>
                                    <p class="text-sm font-medium text-text-primary">Email vérifié</p>
                                    <p class="text-xs text-text-secondary">Forcer la vérification de l'email</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" 
                                           name="is_verified" 
                                           value="true"
                                           {% if user_to_edit.is_verified %}checked{% endif %}
                                           onchange="this.form.submit()"
                                           class="sr-only peer">
                                    <span class="relative inline-block w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-accent/20 rounded-full peer-checked:bg-accent transition-colors duration-200 ease-in-out has-[:checked]:bg-accent">
                                        <span class="absolute top-[2px] left-[2px] inline-block w-5 h-5 bg-white border border-gray-300 rounded-full transition-transform duration-200 ease-in-out has-[:checked]:translate-x-5"></span>
                                    </span>
                                </label>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Réinitialiser mot de passe -->
                    <div class="bg-white rounded-xl shadow-card p-6 border border-gray-border">
                        <h2 class="text-xl font-semibold text-text-primary mb-4">Réinitialiser le mot de passe</h2>
                        
                        <form method="post" action="/admin/users/{{ user_to_edit.id }}/reset-password" 
                              onsubmit="return confirm('Êtes-vous sûr de vouloir réinitialiser le mot de passe de cet utilisateur ? Il devra se reconnecter.')">
                            <div class="space-y-4">
                                <div>
                                    <label for="new_password" class="block text-sm font-medium text-text-secondary mb-1">Nouveau mot de passe</label>
                                    <input type="password" 
                                           id="new_password" 
                                           name="new_password" 
                                           required
                                           minlength="8"
                                           class="w-full px-4 py-2 border border-gray-border rounded-lg focus:ring-2 focus:ring-accent focus:border-transparent"
                                           placeholder="Minimum 8 caractères, majuscule, minuscule, chiffre, spécial">
                                    <p class="text-xs text-text-secondary mt-1">L'utilisateur devra se reconnecter après cette action</p>
                                </div>
                            </div>
                            
                            <button type="submit" class="btn-secondary w-full mt-4">
                                <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path>
                                </svg>
                                Réinitialiser le mot de passe
                            </button>
                        </form>
                    </div>
                </div>
                
                <!-- Actions -->
                <div class="space-y-6">
                    <!-- Statut actif/inactif -->
                    <div class="bg-white rounded-xl shadow-card p-6 border border-gray-border">
                        <h2 class="text-xl font-semibold text-text-primary mb-4">Statut</h2>
                        
                        <form method="post" action="/admin/users/{{ user_to_edit.id }}/toggle-active">
                            <div class="flex items-center justify-between mb-4">
                                <div>
                                    <p class="text-sm font-medium text-text-primary">Compte actif</p>
                                    <p class="text-xs text-text-secondary">Permet de désactiver temporairement un compte</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" 
                                           name="is_active" 
                                           value="true"
                                           {% if user_to_edit.is_active %}checked{% endif %}
                                           onchange="this.form.submit()"
                                           class="sr-only peer">
                                    <span class="relative inline-block w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-accent/20 rounded-full peer-checked:bg-accent transition-colors duration-200 ease-in-out has-[:checked]:bg-accent">
                                        <span class="absolute top-[2px] left-[2px] inline-block w-5 h-5 bg-white border border-gray-300 rounded-full transition-transform duration-200 ease-in-out has-[:checked]:translate-x-5"></span>
                                    </span>
                                </label>
                            </div>
                        </form>
                        
                    </div>
                    
                    <!-- Rôles -->
                    <div class="bg-white rounded-xl shadow-card p-6 border border-gray-border">
                        <h2 class="text-xl font-semibold text-text-primary mb-4">Rôles</h2>
                        
                        <form method="post" action="/admin/users/{{ user_to_edit.id }}/roles">
                            <div class="space-y-3 mb-4">
                                {% for role in available_roles %}
                                <label class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-light cursor-pointer">
                                    <input type="checkbox" 
                                           name="roles" 
                                           value="{{ role.name }}"
                                           {% if role.name in user_to_edit.roles %}checked{% endif %}
                                           class="w-4 h-4 text-accent border-gray-border rounded focus:ring-accent">
                                    <div class="flex-1">
                                        <span class="text-sm font-medium text-text-primary">{{ role.name }}</span>
                                        <span class="text-xs text-text-secondary ml-2">({{ role.user_count or 0 }} utilisateur{{ 's' if role.user_count != 1 else '' }})</span>
                                    </div>
                                </label>
                                {% endfor %}
                            </div>
                            
                            <button type="submit" class="btn-primary w-full">
                                <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                                Enregistrer les rôles
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>
{% endblock %}

